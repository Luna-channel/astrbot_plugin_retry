{
  "max_attempts": {
    "description": "最大重试次数",
    "type": "int",
    "hint": "当LLM回复无效时，插件将尝试重新请求的最大次数。设置为0则禁用重试。",
    "default": 3
  },
  "retry_delay": {
    "description": "重试间隔（秒）",
    "type": "int",
    "hint": "每次重试之间的等待时间，单位为秒。",
    "default": 2
  },
  "retry_delay_mode": {
    "description": "重试间隔模式",
    "type": "string",
    "hint": "选择重试间隔的模式。fixed=每次重试间隔固定，exponential=指数退避（每次翻倍，最大30秒）。",
    "default": "exponential",
    "enum": ["fixed", "exponential"]
  },
  "error_keywords": {
    "description": "触发重试的错误关键词",
    "type": "text",
    "hint": "当LLM的回复中包含这些关键词时，将触发重试。请每行输入一个关键词，不区分大小写。",
    "default": "api 返回的内容为空\nAPI 返回的 completion 由于内容安全过滤被拒绝(非 AstrBot)"
  },
  "retryable_status_codes": {
    "description": "允许重试的HTTP状态码(每行一个)",
    "type": "text",
    "hint": "当错误文本中包含这些状态码时，允许进入重试流程。支持 400/429/502/503/504 等。",
    "default": "400\n429\n502\n503\n504"
  },
  "non_retryable_status_codes": {
    "description": "禁止重试的HTTP状态码(每行一个)",
    "type": "text",
    "hint": "当错误文本中包含这些状态码时，将直接跳过重试。留空表示不限制。",
    "default": ""
  },
  "fallback_reply": {
    "description": "重试全部失败时的兜底回复",
    "type": "text",
    "hint": "当达到最大重试次数仍失败时，发送给用户的一段友好提示。留空则不发送消息。",
    "default": "抱歉，刚才遇到服务波动，我已自动为你重试多次仍未成功。请稍后再试或换个说法。"
  },

  "preserve_full_context": {
    "description": "【鸭】启用完整上下文重试",
    "type": "bool",
    "hint": "开启后，重试时将携带完整的对话历史（受限于压缩和截断设置），解决上下文丢失问题。强烈建议保持开启。",
    "default": true
  },
  "max_context_messages": {
    "description": "【鸭】最大历史消息数",
    "type": "int",
    "hint": "重试时携带的最大历史消息数量。用于控制内存和API请求大小，防止上下文过长。",
    "default": 20
  },
  "context_compression": {
    "description": "【鸭】启用上下文智能压缩",
    "type": "bool",
    "hint": "当历史消息超过“最大历史消息数”时，自动压缩上下文，保留系统消息和最近的对话。",
    "default": true
  },
  "min_context_for_retry": {
    "description": "【鸭】压缩后最小保留消息数",
    "type": "int",
    "hint": "即使启用压缩，也至少会保留这么多条最近的对话，防止上下文被过度压缩。",
    "default": 5
  },
  "max_cache_size": {
    "description": "【鸭】最大请求缓存数量",
    "type": "int",
    "hint": "插件在内存中缓存待重试请求的最大数量，用于防止内存泄漏。达到上限后将淘汰最旧的请求。",
    "default": 50
  },
  "cache_ttl": {
    "description": "【鸭】请求缓存过期时间（秒）",
    "type": "int",
    "hint": "缓存中的待重试请求超过此时间后将被自动清理，进一步防止内存占用。",
    "default": 300
  },
  "enable_context_dedup": {
    "description": "【鸭】启用上下文去重",
    "type": "bool",
    "hint": "在重试时自动去除历史消息中的重复内容，可以略微减少token消耗。",
    "default": true
  },

  "enable_truncation_retry": {
    "description": "启用截断重试",
    "type": "bool",
    "hint": "开启后，检测到回复结尾不是常见标点/字母/数字/文件后缀/网址时自动重试（如 Gemini 截断），建议仅在遇到相关问题时开启。",
    "default": false
  },
  "truncation_detection_mode": {
    "description": "截断检测模式",
    "type": "string",
    "hint": "选择截断检测的复杂度。basic=基础字符检测，enhanced=多层智能检测，strict=严格模式。",
    "default": "enhanced",
    "enum": ["basic", "enhanced", "strict"]
  },
  "check_structural_integrity": {
    "description": "启用结构完整性检测",
    "type": "bool",
    "hint": "检测括号、引号等结构是否匹配，有助于发现被截断的代码或格式化内容。",
    "default": true
  },
  "check_content_type_specific": {
    "description": "启用内容类型自适应检测",
    "type": "bool",
    "hint": "根据内容类型（代码、列表、表格等）使用不同的截断检测策略。",
    "default": true
  },
  "min_reasonable_length": {
    "description": "合理回复最小长度",
    "type": "int",
    "hint": "短于此长度的回复一般不被认为是截断（除非明显不完整）。",
    "default": 10
  },
  "code_block_detection": {
    "description": "启用代码块检测",
    "type": "bool",
    "hint": "检测Markdown代码块是否完整（```配对）。",
    "default": true
  },
  "quote_matching_detection": {
    "description": "启用引号匹配检测",
    "type": "bool",
    "hint": "检测引号是否配对，有助于发现被截断的字符串。",
    "default": true
  },
  "enable_concurrent_retry": {
    "description": "启用并发重试",
    "type": "bool",
    "hint": "开启后，在第一次重试失败后将使用并发模式进行剩余重试，可显著减少响应延迟但会增加token消耗。",
    "default": false
  },
  "concurrent_retry_threshold": {
    "description": "并发重试触发阈值",
    "type": "int",
    "hint": "在第几次重试失败后启动并发模式。例如设为1表示第1次重试失败后启动并发，设为2表示前2次重试失败后启动并发。设置为0则跳过顺序重试，直接使用并发模式。",
    "default": 1
  },
  "concurrent_retry_count": {
    "description": "并发请求数量",
    "type": "int",
    "hint": "并发模式下同时发起的请求数量。数量越多响应越快但token消耗越大，建议2-3个。",
    "default": 2
  },
  "concurrent_retry_timeout": {
    "description": "并发重试超时时间(秒)",
    "type": "int",
    "hint": "等待并发请求完成的最大时间，超时后返回已获得的最佳结果。",
    "default": 30
  },
  "enable_exponential_growth": {
    "description": "启用指数增长并发",
    "type": "bool",
    "hint": "开启后，后续批次的并发数将指数增长(2,4,8...)，但有上限控制。关闭则保持固定并发数。",
    "default": true
  },
  "max_concurrent_multiplier": {
    "description": "最大并发倍数",
    "type": "int",
    "hint": "指数增长的上限倍数，最大并发数=基础并发数×倍数。建议2-8之间。",
    "default": 4
  },
  "absolute_concurrent_limit": {
    "description": "绝对并发上限",
    "type": "int",
    "hint": "无论如何计算，并发数都不会超过此值。建议5-20之间。",
    "default": 10
  }
}
